<main>

  <app-content-header
    title="NFe"
    btn_label="Novo"
    fontIcon="add"
    (onClick)="handleOpenForm()"
  >
    <button mat-flat-button>
      <span matListItemTitle>Consultar</span>
    </button>
    <button mat-flat-button>
      <span matListItemTitle>Enviar</span>
    </button>
</app-content-header>

  @if (nfePaginatedList?.page?.totalElements) {
    <app-generic-table
      [columns]="columns"
      [genericPaginatedList]="nfePaginatedList"
      [totalElements]="nfePaginatedList!.page.totalElements"
      [pageSizeOptions]="[5, 10, 25, 100]"
      (rowClick)="onRowClick($event)"
      (pageEvent)="handlePageEvent($event)"
      (editClick)="handleEdit($event)"
      (selectionChange)="handleSelectionChange($event)"
    />
  } @else {
    @if (nfeListLoading()) {
      <div class="loader-div">
        <span class="loader"></span>
      </div>
    }
    @else {
      @if (nfeListError()) {
        <div class="message-error mat-elevation-z8">
          <h3>Não foi possível acessar os dados da tabela</h3>
          <h4>Tente novamente em alguns minutos.</h4>
        </div>
      }
      @else {
        <br />
        <h2>Não há NFes cadastradas</h2>
      }
    }
  }

  @if (openInfo()) {
    <app-drawer (closeDrawer)="handleCloseDrawer()">
      @if (selectedNfe) {
        <mat-tab-group [selectedIndex]="0">
          <mat-tab label="NFe">
            <div class="nfe-info-container">
              <h2>Informações da NFe</h2>
              <div class="info-grid">
                <div class="info-item">
                  <label>Número:</label>
                  <span>{{ selectedNfe.numero }}</span>
                </div>
                <div class="info-item">
                  <label>Série:</label>
                  <span>{{ selectedNfe.serie }}</span>
                </div>
                <div class="info-item">
                  <label>Status:</label>
                  <span>{{ selectedNfe.status }}</span>
                </div>
                <div class="info-item">
                  <label>CFOP:</label>
                  <span>{{ selectedNfe.cfop }}</span>
                </div>
                <div class="info-item">
                  <label>Tipo:</label>
                  <span>{{ selectedNfe.tipo }}</span>
                </div>
                <div class="info-item">
                  <label>Data de Emissão:</label>
                  <span>{{ selectedNfe.dataEmissao }}</span>
                </div>
                <div class="info-item">
                  <label>Valor Total:</label>
                  <span>R$ {{ selectedNfe.valorTotal | number: '1.2-2' }}</span>
                </div>
                <div class="info-item full-width">
                  <label>Emitente:</label>
                  <span>{{ selectedNfe.emitente.razaoSocial }}</span>
                </div>
                @if (selectedNfe.emitente.nomeFantasia) {
                  <div class="info-item full-width">
                    <label>Nome Fantasia:</label>
                    <span>{{ selectedNfe.emitente.nomeFantasia }}</span>
                  </div>
                }
                <div class="info-item full-width">
                  <label>CNPJ Emitente:</label>
                  <span>{{ selectedNfe.emitente.cnpj }}</span>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      } @else {
        <h1>Dados não encontrados</h1>
      }
    </app-drawer>
  } @if (openForm()) {
    <app-drawer (closeDrawer)="handleConfirmationCloseDrawer()">
      <mat-tab-group [selectedIndex]="selectedTabIndex()">
        <mat-tab label="NFe Entrada">
          <app-nfe-entrada-form 
            [dataForm]="selectedNfe"
            (formSubmitted)="onFormSubmitted()"
            (formChanged)="handleFormChanged($event)"
          />
        </mat-tab>
        <mat-tab label="NFe Saída">
          <app-nfe-saida-form 
            [dataForm]="selectedNfe"
            (formSubmitted)="onFormSubmitted()"
            (formChanged)="handleFormChanged($event)"
          />
        </mat-tab>
      </mat-tab-group>
    </app-drawer>
  }
</main>
