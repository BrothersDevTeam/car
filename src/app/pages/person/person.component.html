<main>
  <div class="search-container">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar pessoa</mat-label>
      <input 
        matInput 
        [(ngModel)]="searchValue"
        (input)="onSearch($event)"
        [placeholder]="'Digite o ' + (searchType === 'name' ? 'nome' : searchType === 'cpf' ? 'CPF' : searchType === 'cnpj' ? 'CNPJ' : searchType === 'email' ? 'email' : 'ID da loja')"
      />
      @if (searchValue) {
        <button matSuffix mat-icon-button aria-label="Limpar" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      }
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="search-type-field">
  <mat-label>Buscar por</mat-label>
  <mat-select [(value)]="searchType" (selectionChange)="onSearchTypeChange($event.value)">
    <!-- NOVA OPÇÃO: Buscar em todos os campos -->
    <mat-option value="all">Todos</mat-option>
    <mat-option value="name">Nome</mat-option>
    <mat-option value="cpf">CPF</mat-option>
    <mat-option value="cnpj">CNPJ</mat-option>
    <mat-option value="email">Email</mat-option>
    @if (isCarAdmin) {
      <mat-option value="storeId">Loja (ID)</mat-option>
    }
  </mat-select>
</mat-form-field>
  </div>

  <app-content-header
    title="Pessoas"
    btn_label="Novo"
    fontIcon="add"
    (onClick)="handleOpenForm()"
  />

  @if (personPaginatedList?.page?.totalElements) {
    <app-generic-table
      [columns]="columns"
      [genericPaginatedList]="personPaginatedList"
      [totalElements]="personPaginatedList!.page.totalElements"
      [pageSizeOptions]="[5, 10, 25, 100]"
      (rowClick)="onRowClick($event)"
      (pageEvent)="handlePageEvent($event)"
      (editClick)="handleEdit($event)"
      (deleteClick)="handleDelete($event)"
    ></app-generic-table>
  } @else {
    @if (clientListLoading()) {
      <div class="loader-div">
        <span class="loader"></span>
      </div>
    } @else {
      @if (clientListError()) {
        <div class="message-error mat-elevation-z8">
          <h3>Não foi possível acessar os dados da tabela</h3>
          <h4>Tente novamente em alguns minutos.</h4>
        </div>
      } @else {
        <br />
        <h2>Não há pessoas cadastradas.</h2>
      }
    }
  } @if (openInfo()) {
    <app-drawer (closeDrawer)="handleCloseDrawer()">
      @if (!selectedPerson?.legalEntity) {
        <mat-tab-group [selectedIndex]="0">
          <mat-tab label="Pessoa Física">
            <app-natural-person-info
              (editEvent)="handleEdit()"
              [person]="selectedPerson!"
              (formSubmitted)="onFormSubmitted()"
            />
          </mat-tab>
          <mat-tab label="Negócios efetuados">
            <app-business-done-table />
          </mat-tab>
        </mat-tab-group>
      } @else if(selectedPerson?.legalEntity) {
        <mat-tab-group [selectedIndex]="0">
          <mat-tab label="Pessoa Jurídica">
            <app-legal-entity-info
              (editEvent)="handleEdit()"
              [person]="selectedPerson!"
              (formSubmitted)="onFormSubmitted()"
            />
          </mat-tab>
          <mat-tab label="Negócios efetuados">
            <app-business-done-table />
          </mat-tab>
        </mat-tab-group>
      } @else {
      <h1>Dados não encontrados</h1>
      }
    </app-drawer>
  } @if (openForm()) {
  <app-drawer (closeDrawer)="handleConfirmationCloseDrawer()">
    <mat-tab-group [selectedIndex]="selectedPerson?.legalEntity ? 1 : 0">
      <mat-tab
        label="Pessoa Física"
        [disabled]="selectedPerson && selectedPerson.legalEntity"
      >
        <app-natural-person-form
          [dataForm]="!selectedPerson?.legalEntity ? selectedPerson : null"
          (formSubmitted)="onFormSubmitted()"
          (formChanged)="handleFormChanged($event)"
        />
      </mat-tab>
      <mat-tab
        label="Pessoa Jurídica"
        [disabled]="selectedPerson && !selectedPerson.legalEntity"
      >
        <app-legal-entity-form
          [dataForm]="selectedPerson?.legalEntity ? selectedPerson : null"
          (formSubmitted)="onFormSubmitted()"
          (formChanged)="handleFormChanged($event)"
        />
      </mat-tab>
    </mat-tab-group>
  </app-drawer>
  }
</main>
