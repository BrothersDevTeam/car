<h2 mat-dialog-title>{{ getDialogTitle() }}</h2>

<mat-dialog-content>
  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Carregando pessoas...</p>
    </div>
  } @else if (error) {
    <div class="error-container">
      <p>Erro ao carregar pessoas. Tente novamente.</p>
    </div>
  } @else if (persons.length === 0) {
    <div class="empty-container">
      <p>Nenhuma pessoa ativa cadastrada nesta loja.</p>
      <p class="hint">
        Cadastre uma pessoa primeiro para vincul√°-la como propriet√°ria.
      </p>
    </div>
  } @else {
    <form
      [formGroup]="ownerForm"
      class="owner-form"
    >
      <div class="info-box">
        <p>
          <strong>Loja:</strong>
          {{ data.store.name }}
        </p>
        @if (mode === 'update' && currentOwner) {
          <div class="current-owner-info">
            <p><strong>Propriet√°rio Atual:</strong></p>
            <p class="owner-name">{{ currentOwner.name }}</p>
            <p class="owner-doc">
              {{ currentOwner.legalEntity ? 'CNPJ' : 'CPF' }}:
              {{
                currentOwner.legalEntity ? currentOwner.cnpj : currentOwner.cpf
              }}
            </p>
          </div>
        }
      </div>

      <mat-form-field
        appearance="outline"
        class="full-width"
      >
        <mat-label>
          {{
            mode === 'update'
              ? 'Selecione o novo propriet√°rio'
              : 'Selecione a pessoa'
          }}
        </mat-label>
        <mat-select formControlName="personId">
          @for (person of persons; track person.personId) {
            <mat-option
              [value]="person.personId"
              [disabled]="isCurrentOwner(person.personId)"
            >
              {{ getPersonDisplay(person) }}
              @if (isCurrentOwner(person.personId)) {
                <span class="current-badge">(Atual)</span>
              }
            </mat-option>
          }
        </mat-select>
        @if (
          ownerForm.get('personId')?.invalid &&
          ownerForm.get('personId')?.touched
        ) {
          <mat-error>Selecione uma pessoa</mat-error>
        }
      </mat-form-field>

      <div class="hint-text">
        @if (mode === 'update') {
          <p>
            üîÑ Voc√™ est√° prestes a
            <strong>alterar</strong>
            o propriet√°rio desta loja.
          </p>
          <p>
            üíº O propriet√°rio antigo permanecer√° como Person normal na loja.
          </p>
          <p>‚ÑπÔ∏è Opera√ß√£o permitida apenas para CAR_ADMIN.</p>
        } @else {
          <p>
            üí° Apenas pessoas ativas desta loja podem ser vinculadas como
            propriet√°rias.
          </p>
        }
      </div>
    </form>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button
    mat-button
    (click)="onCancel()"
  >
    Cancelar
  </button>
  @if (!loading && !error && persons.length > 0) {
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="ownerForm.invalid"
    >
      {{ getActionButtonText() }}
    </button>
  }
</mat-dialog-actions>
